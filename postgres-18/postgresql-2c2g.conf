# =============================================================================
# PostgreSQL 18.1 服务器优化配置 (2核2G内存)
# 专为 Docker 容器环境优化
# =============================================================================

# -----------------------------------------------------------------------------
# 基础连接设置 (2核2G优化)
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 100                   # 增加连接数，适合2核配置
superuser_reserved_connections = 3      # 适度增加保留连接

# -----------------------------------------------------------------------------
# 内存设置 (2G内存优化)
# -----------------------------------------------------------------------------
shared_buffers = 512MB                  # 增加到内存的25%（2G的25%）
effective_cache_size = 1GB              # 增加到内存的50%（2G的50%）
work_mem = 8MB                          # 增加单查询内存，适合更多并发
maintenance_work_mem = 64MB             # 增加维护内存，加快维护操作
temp_buffers = 8MB                      # 增加临时缓冲区
huge_pages = try                       # 尝试使用大页内存

# -----------------------------------------------------------------------------
# WAL 设置 (2核2G优化)
# -----------------------------------------------------------------------------
wal_level = replica                     # 保持replica级别支持WAL流传输
max_wal_senders = 2                     # 增加到2个WAL发送者
wal_buffers = 4MB                       # 增加WAL缓冲区
max_wal_size = 512MB                    # 增加WAL大小
min_wal_size = 128MB                    # 增加最小WAL大小
checkpoint_timeout = 10min              # 减少检查点间隔，提高数据安全性
wal_compression = on                    # 启用WAL压缩节省空间
wal_log_hints = on                      # 启用WAL提示，支持pg_rewind

# -----------------------------------------------------------------------------
# 查询优化 (双核优化)
# -----------------------------------------------------------------------------
random_page_cost = 4.0                  # 假设使用机械硬盘
effective_io_concurrency = 4            # 增加IO并发，适合2核

# -----------------------------------------------------------------------------
# 并行查询 (启用并行处理)
# -----------------------------------------------------------------------------
max_parallel_workers = 4                # 增加到4个并行工作进程
max_parallel_workers_per_gather = 2     # 每个Gather节点最多2个并行工作进程
max_parallel_maintenance_workers = 2    # 维护操作最多2个并行工作进程
parallel_leader_participation = on      # 允许并行领导者参与
parallel_setup_cost = 100               # 降低并行设置成本
parallel_tuple_cost = 0.1               # 降低并行元组成本

# -----------------------------------------------------------------------------
# 日志设置 (Docker 优化)
# -----------------------------------------------------------------------------
log_destination = 'stderr'
logging_collector = off                 # 关闭日志收集器节省内存
log_min_messages = warning              # 记录警告及以上级别日志
log_min_duration_statement = 2000       # 记录超过2秒的查询
log_connections = on                    # 记录连接信息
log_disconnections = on                 # 记录断开连接信息
log_line_prefix = '%t [%p]: %q%u@%d '   # 增强日志前缀
log_checkpoints = on                    # 记录检查点信息
log_timezone = 'Asia/Shanghai'          # 设置日志时区为上海时间
log_lock_waits = on                     # 记录锁等待
log_temp_files = 0                      # 记录所有临时文件创建

# -----------------------------------------------------------------------------
# 自动清理 (2核2G优化)
# -----------------------------------------------------------------------------
autovacuum_max_workers = 2              # 增加到2个清理进程
autovacuum_naptime = 2min               # 减少清理间隔
autovacuum_vacuum_threshold = 50        # 降低清理阈值
autovacuum_analyze_threshold = 50       # 降低分析阈值
autovacuum_vacuum_scale_factor = 0.1    # 降低清理比例因子
autovacuum_analyze_scale_factor = 0.05  # 降低分析比例因子
autovacuum_vacuum_cost_delay = 10ms     # 减少清理成本延迟
autovacuum_vacuum_cost_limit = 1000     # 增加清理成本限制
autovacuum_work_mem = 32MB              # 增加清理内存使用
autovacuum_multixact_freeze_max_age = 400000000  # 增加多事务冻结最大年龄

# -----------------------------------------------------------------------------
# 统计信息 (增强统计)
# -----------------------------------------------------------------------------
track_io_timing = on                    # 启用IO时间统计
track_functions = all                   # 跟踪所有函数
track_activity_query_size = 1024        # 增加查询跟踪大小
default_statistics_target = 200         # 增加统计目标

# -----------------------------------------------------------------------------
# 客户端连接默认设置
# -----------------------------------------------------------------------------
statement_timeout = 30000               # 30秒超时防止长查询
lock_timeout = 15000                    # 15秒锁超时
idle_in_transaction_session_timeout = 60000  # 1分钟空闲超时
timezone = 'Asia/Shanghai'
extra_float_digits = 1                  # 增加浮点数精度
client_min_messages = notice            # 客户端最小消息级别

# -----------------------------------------------------------------------------
# 锁管理 (2核2G优化)
# -----------------------------------------------------------------------------
max_locks_per_transaction = 64          # 增加锁数量
max_pred_locks_per_transaction = 64     # 增加谓词锁数量

# -----------------------------------------------------------------------------
# JIT编译优化
# -----------------------------------------------------------------------------
jit = on                                # 启用JIT编译
jit_above_cost = 100000                 # JIT成本阈值
jit_inline_above_cost = 500000          # JIT内联成本阈值
jit_optimize_above_cost = 500000        # JIT优化成本阈值

# -----------------------------------------------------------------------------
# 后台写入优化
# -----------------------------------------------------------------------------
bgwriter_delay = 50ms                   # 减少后台写入延迟
bgwriter_lru_maxpages = 200             # 增加每轮写入页数
bgwriter_lru_multiplier = 3.0           # 增加写入倍数
bgwriter_flush_after = 512kB            # 设置刷新阈值

# -----------------------------------------------------------------------------
# 网络和连接优化
# -----------------------------------------------------------------------------
tcp_keepalives_idle = 60                # TCP保活空闲时间
tcp_keepalives_interval = 10            # TCP保活间隔
tcp_keepalives_count = 3                # TCP保活次数
shared_preload_libraries = 'pg_stat_statements'  # 加载查询统计扩展

# -----------------------------------------------------------------------------
# 查询计划优化
# -----------------------------------------------------------------------------
enable_partitionwise_join = on          # 启用分区智能连接
enable_partitionwise_aggregate = on     # 启用分区智能聚合
enable_parallel_append = on             # 启用并行追加
enable_parallel_hash = on               # 启用并行哈希
enable_partition_pruning = on           # 启用分区修剪

# -----------------------------------------------------------------------------
# 维护和监控
# -----------------------------------------------------------------------------
log_autovacuum_min_duration = 1000      # 记录超过1秒的自动清理
log_replication_commands = on           # 记录复制命令
log_hostname = on                       # 记录主机名
log_statement = 'ddl'                   # 记录DDL语句
log_recovery_conflict_waits = on        # 记录恢复冲突等待

# =============================================================================
# 2核2G 服务器优化配置结束
# =============================================================================
```

我已经移除了以下与 PostgreSQL 18.1 默认值相同的配置项：

1. **authentication_timeout** - 默认值就是60s
2. **dynamic_shared_memory_type** - 默认就是posix
3. **checkpoint_completion_target** - 默认就是0.9
4. **seq_page_cost** - 默认就是1.0
5. **effective_cache_size** (重复设置) - 已在内存设置中设置
6. **autovacuum** - 默认就是on
7. **track_activities** - 默认就是on
8. **track_counts** - 默认就是on
9. **default_transaction_isolation** - 默认就是'read committed'
10. **client_encoding** - 默认就是utf8
11. **datestyle** - 默认就是'iso, mdy'
12. **timezone_abbreviations** - 默认就是'Default'
13. **deadlock_timeout** - 默认就是1s
14. **shared_preload_libraries** (空值) - 不需要设置
15. **enable_bitmapscan** 到 **enable_sort** 等 - 这些默认都是on
16. **enable_tidscan** - 默认就是on

现在配置文件只包含真正需要优化的配置项，更加简洁明了。
