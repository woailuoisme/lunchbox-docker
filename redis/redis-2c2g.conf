# Redis 8.4 配置文件 - 2核2G内存性能优化版
# 专注于高性能配置，充分利用双核资源

################################## 网络配置 #####################################
bind 0.0.0.0                      # 监听所有网络接口，容器化必需
protected-mode no                 # 关闭保护模式，允许外部连接
tcp-keepalive 30                  # 减少TCP保活间隔，快速释放无效连接
tcp-backlog 1024                  # 增加TCP连接队列，提高并发处理能力

################################# 通用配置 #####################################
daemonize no                      # 非守护进程模式，容器化必需
databases 16                      # 使用默认数据库数量，提供完全灵活性
always-show-logo no               # 不显示启动logo，减少启动输出

# Redis 8.4 新特性：命令预取优化
lookahead 64                      # 大幅增加命令预取深度，充分利用双核

################################ 快照持久化 ################################
# 高性能持久化策略
save 900 1                        # 15分钟至少1次变更
save 300 10                       # 5分钟至少10次变更
save 60 10000                     # 1分钟至少10000次变更
stop-writes-on-bgsave-error no    # RDB失败时不停止写入，保证高可用性
rdbcompression yes                # 启用RDB压缩，节省磁盘空间
rdbchecksum yes                   # 启用RDB校验，保证数据完整性

# Redis 8.4 新特性：AOF损坏自动修复
aof-load-corrupt-tail-max-size 10mb  # 允许自动修复最多10MB的AOF损坏

############################## 内存管理 ################################
maxmemory 1.5gb                   # 最大内存1.5GB（为系统预留512MB）
maxmemory-policy allkeys-lru      # 淘汰策略：所有key中的LRU，提高缓存命中率
maxmemory-samples 20              # 大幅增加采样数，提高淘汰精度

############################# 惰性删除 ####################################
# 全面启用惰性删除，最大化主线程性能
lazyfree-lazy-eviction yes        # 启用惰性删除
lazyfree-lazy-expire yes          # 启用惰性过期删除
lazyfree-lazy-server-del yes      # 启用惰性服务器删除
replica-lazy-flush yes            # 启用从节点惰性刷新

############################## AOF持久化 ###############################
appendonly yes                    # 启用AOF，提供更好的数据持久性
appendfilename "appendonly.aof"   # AOF文件名
appendfsync everysec              # 每秒同步，平衡性能与数据安全
no-appendfsync-on-rewrite no      # 重写时不停止fsync，保证数据安全
auto-aof-rewrite-percentage 100   # AOF重写触发百分比
auto-aof-rewrite-min-size 64mb    # 增加AOF重写最小文件大小
aof-load-truncated yes            # 加载截断的AOF文件
aof-use-rdb-preamble yes          # 使用RDB格式的AOF前导，大幅提高加载速度

################################## 慢日志 ###################################
slowlog-log-slower-than 2000      # 降低慢查询阈值到2ms，更敏感的性能监控
slowlog-max-len 512               # 大幅增加慢日志长度，提供详细调试信息

################################ 延迟监控 ##############################
latency-monitor-threshold 50      # 降低延迟监控阈值到50ms，更精细的性能监控

############################### 高级配置 ###############################
# 数据结构优化（性能最大化）
hash-max-ziplist-entries 512      # 增加哈希ziplist条目，平衡内存与性能
hash-max-ziplist-value 256        # 大幅增加哈希ziplist值大小，减少转换开销
list-max-ziplist-size -2          # 列表使用LINKEDLIST，提高大列表性能
list-compress-depth 0             # 不压缩列表，最大化性能
set-max-intset-entries 512        # 增加intset条目，提高小集合性能
zset-max-ziplist-entries 128      # 增加有序集合ziplist条目
zset-max-ziplist-value 256        # 大幅增加有序集合ziplist值大小
hll-sparse-max-bytes 3000         # 增加HyperLogLog稀疏表示大小

# 流数据结构优化
stream-node-max-bytes 16384       # 大幅增加流节点大小，提高流处理性能
stream-node-max-entries 500       # 大幅增加流节点条目数

# 客户端输出缓冲区限制
client-output-buffer-limit normal 0 0 0  # 普通客户端无限制
client-output-buffer-limit replica 256mb 128mb 180  # 大幅增加从节点缓冲区
client-output-buffer-limit pubsub 128mb 64mb 180    # 大幅增加Pub/Sub缓冲区

# 后台任务优化
hz 50                            # 大幅增加后台任务频率，提高响应性
dynamic-hz yes                   # 启用动态频率调整，根据负载优化

# 增量式fsync优化
aof-rewrite-incremental-fsync yes  # 启用增量式AOF重写fsync
rdb-save-incremental-fsync yes     # 启用增量式RDB保存fsync

# 连接管理优化
maxclients 10000                 # 大幅增加最大连接数，支持高并发
repl-backlog-size 4mb            # 大幅增加复制积压缓冲区大小
repl-backlog-ttl 3600            # 增加复制积压缓冲区TTL

# 线程化I/O优化（Redis 8.4增强）
io-threads 4                     # 增加I/O线程数到4（2核环境建议4）
io-threads-do-reads yes          # 启用读线程，大幅提高读取性能

# 内存碎片整理
activedefrag yes                 # 启用主动碎片整理，提高内存利用率
active-defrag-ignore-bytes 100mb # 增加碎片忽略阈值
active-defrag-threshold-lower 10 # 降低碎片整理下限阈值
active-defrag-threshold-upper 100 # 增加碎片整理上限阈值
active-defrag-cycle-min 5        # 降低最小整理周期
active-defrag-cycle-max 75       # 增加最大整理周期
active-defrag-max-scan-fields 1000 # 增加最大扫描字段数

# 网络优化
repl-disable-tcp-nodelay no      # 不禁用TCP_NODELAY，减少延迟
repl-diskless-sync yes           # 启用无盘复制，提高复制性能
repl-diskless-sync-delay 1       # 大幅减少无盘复制延迟
repl-diskless-load disabled      # 禁用无盘加载

# 安全增强
rename-command FLUSHDB ""        # 完全禁用危险命令
rename-command FLUSHALL ""
rename-command CONFIG ""
rename-command SHUTDOWN ""

# 监控和调试
profiling-sample-commands "get,set,incr,decr,lpush,rpush,lpop,rpop,hget,hset"
profiling-sample-frequency 5000   # 增加采样频率，提供更详细性能数据

# 容器化优化
oom-score-adj yes                 # 调整OOM分数，提高容器稳定性
oom-score-adj-values 0 200 800    # 设置OOM分数调整值

# Redis 8.4 新特性：性能监控增强
latency-tracking yes              # 启用延迟跟踪
latency-tracking-info-percentiles 50 90 95 99 99.9  # 详细延迟百分位监控

# LUA脚本优化
lua-time-limit 5000               # 增加Lua脚本超时时间，支持复杂脚本
decode_array_with_array_mt yes    # 优化Lua中JSON数组的内存使用

# 客户端连接优化
client-query-buffer-limit 2gb     # 大幅增加查询缓冲区限制
proto-max-bulk-len 1gb            # 大幅增加批量操作长度限制

# 性能优化标志
jemalloc-bg-thread yes            # 启用jemalloc后台线程

# Redis 8.4 搜索功能优化（如使用RediSearch）
search-default-scorer BM25STD     # 默认评分算法
search-io-threads 2               # 搜索IO线程数
search-on-oom ignore              # OOM时忽略搜索错误

# 集群优化（如使用集群）
cluster-enabled no                # 默认不启用集群
cluster-config-file nodes.conf
cluster-node-timeout 5000
cluster-replica-validity-factor 10
cluster-migration-barrier 1
cluster-require-full-coverage yes

# 系统资源优化
syslog-enabled no                 # 不启用系统日志，减少开销
notify-keyspace-events ""         # 不启用keyspace通知，减少开销

# 性能调优标志
repl-timeout 60                   # 增加复制超时时间
repl-ping-slave-period 10         # 减少从节点ping周期
repl-ping-replica-period 10       # 减少副本ping周期

# 高级性能优化
hash-max-listpack-entries 512     # Redis 8.4新特性：哈希listpack条目
hash-max-listpack-value 64        # Redis 8.4新特性：哈希listpack值大小
stream-node-max-listpack-size 4096 # Redis 8.4新特性：流listpack大小
stream-node-max-listpack-entries 100 # Redis 8.4新特性：流listpack条目
