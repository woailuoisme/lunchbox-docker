# Redis 8.4 配置文件 - 1核1G内存优化版
# 只包含非默认值的优化配置

################################## 网络配置 #####################################
bind 0.0.0.0                      # 监听所有网络接口
protected-mode no                 # 关闭保护模式（适合容器化部署）
port 6379                         # 监听端口
tcp-backlog 511                   # TCP连接队列长度
timeout 0                         # 连接不超时
tcp-keepalive 300                 # TCP保活间隔

################################# 通用配置 #####################################
daemonize no                      # 非守护进程模式（容器化必需）
supervised no                     # 无监督模式
pidfile /var/run/redis_6379.pid   # PID文件位置
loglevel notice                   # 日志级别：notice
logfile ""                        # 日志输出到标准输出（容器友好）
databases 1                       # 减少数据库数量（节省内存）
always-show-logo no               # 不显示启动logo

# Redis 8.4 新特性：命令预取优化
lookahead 32                      # 增加命令预取深度（默认16），提升吞吐量

################################## 安全配置 ##################################
requirepass your_strong_password  # 设置强密码（请修改）

################################ 快照持久化 ################################
# 针对1G内存的优化保存策略
save 900 1                        # 15分钟至少1次变更
save 300 10                       # 5分钟至少10次变更
save 60 10000                     # 1分钟至少10000次变更
stop-writes-on-bgsave-error no    # RDB失败不停止写入（提高可用性）
rdbcompression yes                # RDB文件压缩
rdbchecksum yes                   # RDB文件校验
dbfilename dump.rdb               # RDB文件名
dir ./                            # 工作目录

# Redis 8.4 新特性：AOF损坏自动修复
aof-load-corrupt-tail-max-size 10mb  # 允许自动修复最多10MB的AOF损坏

############################## 内存管理 ################################
maxmemory 768mb                   # 最大内存768MB（为系统预留256MB）
maxmemory-policy volatile-lru     # 淘汰策略：淘汰过期key中的LRU
maxmemory-samples 5               # 采样数（平衡精度和性能）

# Redis 8.4 新特性：内存不足时的搜索行为控制
# search-on-oom ignore            # OOM时忽略搜索错误（如使用搜索功能请启用）

############################# 惰性删除 ####################################
# 针对1核CPU优化：关闭惰性删除以减少CPU开销
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

############################## AOF持久化 ###############################
appendonly no                     # 关闭AOF（节省IO资源，适合1核环境）
# 如启用AOF，使用以下优化配置：
# appendonly yes
# appendfsync everysec
# no-appendfsync-on-rewrite no
# auto-aof-rewrite-percentage 100
# auto-aof-rewrite-min-size 64mb
# aof-load-truncated yes

################################ LUA脚本 ###############################
lua-time-limit 5000               # Lua脚本超时5秒

# Redis 8.4 新特性：JSON数组内存优化
decode_array_with_array_mt yes    # 优化Lua中JSON数组的内存使用

################################## 慢日志 ###################################
slowlog-log-slower-than 10000     # 慢查询阈值10ms
slowlog-max-len 128               # 慢日志长度

################################ 延迟监控 ##############################
latency-monitor-threshold 0       # 关闭延迟监控（节省CPU）

############################### 高级配置 ###############################
# 数据结构优化（降低内存占用）
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
hll-sparse-max-bytes 3000

# 流数据结构优化
stream-node-max-bytes 4096
stream-node-max-entries 100

# 客户端输出缓冲区限制
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# 后台任务优化
hz 10                            # 后台任务频率
dynamic-hz yes                   # 启用动态频率调整

# 增量式fsync优化
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes

# 连接管理优化
maxclients 10000                 # 最大客户端连接数
repl-backlog-size 1mb            # 复制积压缓冲区大小
repl-backlog-ttl 3600            # 复制积压缓冲区TTL

# 集群优化（如使用集群）
# cluster-enabled yes
# cluster-config-file nodes.conf
# cluster-node-timeout 5000
# cluster-replica-validity-factor 10
# cluster-migration-barrier 1
# cluster-require-full-coverage yes

# Redis 8.4 新特性：搜索功能优化（如使用RediSearch）
# search-default-scorer BM25STD    # 默认评分算法
# search-io-threads 2              # 搜索IO线程数
# search-on-oom ignore             # OOM时的搜索行为

# 性能监控优化
# 启用以下配置可提供更详细的监控信息
# latency-tracking yes
# latency-tracking-info-percentiles 50 99 99.9

# 线程化I/O优化（Redis 8.4增强）
io-threads 2                     # I/O线程数（1核环境建议2）
io-threads-do-reads no           # 默认不启用读线程

# 内存碎片整理
activedefrag no                  # 关闭主动碎片整理（节省CPU）
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 5
active-defrag-cycle-max 75
active-defrag-max-scan-fields 1000

# 网络优化
repl-disable-tcp-nodelay no
repl-diskless-sync no
repl-diskless-sync-delay 5
repl-diskless-load disabled

# 安全增强
rename-command FLUSHDB ""        # 禁用危险命令
rename-command FLUSHALL ""
rename-command CONFIG ""
rename-command SHUTDOWN ""

# 监控和调试
profiling-sample-commands "get,set,incr"
profiling-sample-frequency 0

# 系统资源限制警告
syslog-enabled no
syslog-ident redis
syslog-facility local0

# 容器化优化
oom-score-adj no                 # 不调整OOM分数
oom-score-adj-values 0 200 800
