# Redis 8.4 配置文件 - 1核1G内存性能优化版
# 专注于关键性能优化，移除所有默认值配置

################################## 网络配置 #####################################
bind 0.0.0.0                      # 监听所有网络接口，容器化必需
protected-mode no                 # 关闭保护模式，允许外部连接
tcp-keepalive 60                  # 减少TCP保活间隔，更快释放无效连接

################################# 通用配置 #####################################
daemonize no                      # 非守护进程模式，容器化必需
databases 8                       # 适度数据库数量，平衡灵活性与内存
always-show-logo no               # 不显示启动logo，减少启动输出

# Redis 8.4 新特性：命令预取优化
lookahead 48                      # 增加命令预取深度，提升单核吞吐量

################################## 日志配置 #####################################
loglevel notice                   # 日志级别：debug/verbose/notice/warning
logfile ""                        # 日志文件路径，空字符串表示标准输出
syslog-enabled no                 # 禁用系统日志，使用容器日志
syslog-ident redis                # 系统日志标识符
syslog-facility local0            # 系统日志设施

################################ 快照持久化 ################################
# 性能导向的保存策略
save 900 1                        # 15分钟至少1次变更
save 300 10                       # 5分钟至少10次变更
save 60 10000                     # 1分钟至少10000次变更
stop-writes-on-bgsave-error yes   # RDB失败时停止写入，保证数据一致性
rdbcompression yes                # 启用RDB压缩，节省磁盘空间

# Redis 8.4 新特性：AOF损坏自动修复
aof-load-corrupt-tail-max-size 5mb  # 允许自动修复最多5MB的AOF损坏

############################## 内存管理 ################################
maxmemory 800mb                   # 最大内存800MB（为系统预留224MB）
maxmemory-policy allkeys-lru      # 淘汰策略：所有key中的LRU，提高缓存命中率
maxmemory-samples 10              # 增加采样数，提高淘汰精度

############################# 惰性删除 ####################################
# 性能优化：启用惰性删除减少主线程阻塞
lazyfree-lazy-eviction yes        # 启用惰性删除
lazyfree-lazy-expire yes          # 启用惰性过期删除
lazyfree-lazy-server-del yes      # 启用惰性服务器删除

############################## AOF持久化 ###############################
appendonly yes                    # 启用AOF，提供更好的数据持久性
appendfsync everysec              # 每秒同步，平衡性能与数据安全
no-appendfsync-on-rewrite no      # 重写时不停止fsync，保证数据安全
auto-aof-rewrite-percentage 100   # AOF重写触发百分比
auto-aof-rewrite-min-size 32mb    # AOF重写最小文件大小
aof-use-rdb-preamble yes          # 使用RDB格式的AOF前导，提高加载速度

################################## 慢日志 ###################################
slowlog-log-slower-than 5000      # 慢查询阈值5ms，敏感性能监控
slowlog-max-len 256               # 增加慢日志长度，提供更多调试信息

################################ 延迟监控 ##############################
latency-monitor-threshold 100     # 启用延迟监控，阈值100ms

############################### 高级配置 ###############################
# 数据结构优化（性能优先）
hash-max-ziplist-entries 256      # 减少哈希ziplist条目，提高查询性能
hash-max-ziplist-value 128        # 增加哈希ziplist值大小，减少内存碎片
list-max-ziplist-size -2          # 列表使用LINKEDLIST，提高大列表性能
set-max-intset-entries 256        # 减少intset条目，提高集合性能
zset-max-ziplist-entries 64       # 减少有序集合ziplist条目
zset-max-ziplist-value 128        # 增加有序集合ziplist值大小

# 流数据结构优化
stream-node-max-bytes 8192        # 增加流节点大小，提高流处理性能
stream-node-max-entries 200       # 增加流节点条目数

# 客户端输出缓冲区限制
client-output-buffer-limit replica 128mb 64mb 120  # 从节点缓冲区限制
client-output-buffer-limit pubsub 64mb 32mb 120    # Pub/Sub缓冲区限制

# 后台任务优化
hz 20                            # 增加后台任务频率，提高响应性
dynamic-hz yes                   # 启用动态频率调整，根据负载优化

# 增量式fsync优化
aof-rewrite-incremental-fsync yes  # 启用增量式AOF重写fsync
rdb-save-incremental-fsync yes     # 启用增量式RDB保存fsync

# 连接管理优化
maxclients 5000                  # 适度减少最大连接数，避免资源耗尽
repl-backlog-size 2mb            # 增加复制积压缓冲区大小

# 线程化I/O优化（Redis 8.4增强）
io-threads 2                     # I/O线程数（1核环境建议2）
io-threads-do-reads yes          # 启用读线程，提高读取性能

# 内存碎片整理
activedefrag yes                 # 启用主动碎片整理，提高内存利用率
active-defrag-ignore-bytes 50mb  # 碎片忽略阈值
active-defrag-threshold-lower 20 # 碎片整理下限阈值
active-defrag-threshold-upper 80 # 碎片整理上限阈值

# 网络优化
repl-disable-tcp-nodelay no      # 不禁用TCP_NODELAY，减少延迟
repl-diskless-sync yes           # 启用无盘复制，提高复制性能
repl-diskless-sync-delay 2       # 减少无盘复制延迟

# 安全增强
rename-command FLUSHDB "FLUSHDB_SECURE"  # 重命名危险命令
rename-command FLUSHALL "FLUSHALL_SECURE"
rename-command CONFIG "CONFIG_SECURE"

# 监控和调试
profiling-sample-commands "get,set,incr,decr,lpush,rpush,lpop,rpop"

# 容器化优化
oom-score-adj yes                 # 调整OOM分数，提高容器稳定性

# Redis 8.4 新特性：性能监控增强
latency-tracking yes              # 启用延迟跟踪
latency-tracking-info-percentiles 50 95 99  # 延迟百分位监控

# LUA脚本优化
lua-time-limit 3000               # 减少Lua脚本超时时间，防止阻塞

# 客户端连接优化
client-query-buffer-limit 1gb     # 增加查询缓冲区限制
proto-max-bulk-len 512mb          # 增加批量操作长度限制

# 性能优化标志
jemalloc-bg-thread yes            # 启用jemalloc后台线程
