# Redis 8.4 配置文件 - 1核1G内存性能优化版
# 专注于关键性能优化，移除所有默认值配置

################################## 网络配置 #####################################
bind 0.0.0.0                      # 监听所有网络接口，容器化必需
protected-mode no                 # 关闭保护模式，允许外部连接
tcp-keepalive 60                  # 减少TCP保活间隔，更快释放无效连接

################################# 通用配置 #####################################
daemonize no                      # 非守护进程模式，容器化必需
databases 8                       # 适度数据库数量，平衡灵活性与内存
always-show-logo no               # 不显示启动logo，减少启动输出

# Redis 8.4 新特性：命令预取优化
lookahead 48                      # 增加命令预取深度，提升单核吞吐量

################################## 日志配置 #####################################
loglevel notice                   # 日志级别：debug/verbose/notice/warning
logfile ""                        # 日志文件路径，空字符串表示标准输出
syslog-enabled no                 # 禁用系统日志，使用容器日志
syslog-ident redis                # 系统日志标识符
syslog-facility local0            # 系统日志设施

################################ 快照持久化 ################################
# 性能导向的保存策略
save 900 1                        # 15分钟至少1次变更
save 300 10                       # 5分钟至少10次变更
save 60 10000                     # 1分钟至少10000次变更
stop-writes-on-bgsave-error yes   # RDB失败时停止写入，保证数据一致性
rdbcompression yes                # 启用RDB压缩，节省磁盘空间

# Redis 8.4 新特性：AOF损坏自动修复
aof-load-corrupt-tail-max-size 5mb  # 允许自动修复最多5MB的AOF损坏

############################## 内存管理 ################################
maxmemory 800mb                   # 最大内存800MB（为系统预留224MB）
maxmemory-policy allkeys-lru      # 淘汰策略：所有key中的LRU，提高缓存命中率
maxmemory-samples 10              # 增加采样数，提高淘汰精度

############################# 惰性删除 ####################################
# 性能优化：启用惰性删除减少主线程阻塞
lazyfree-lazy-eviction yes        # 启用惰性删除
lazyfree-lazy-expire yes          # 启用惰性过期删除
lazyfree-lazy-server-del yes      # 启用惰性服务器删除

############################## AOF持久化 ###############################
appendonly yes                    # 启用AOF，提供更好的数据持久性
appendfsync everysec              # 每秒同步，平衡性能与数据安全
no-appendfsync-on-rewrite no      # 重写时不停止fsync，保证数据安全
auto-aof-rewrite-percentage 100   # AOF重写触发百分比
auto-aof-rewrite-min-size 32mb    # AOF重写最小文件大小
aof-use-rdb-preamble yes          # 使用RDB格式的AOF前导，提高加载速度

################################## 慢日志 ###################################
slowlog-log-slower-than 5000      # 慢查询阈值5ms，敏感性能监控
slowlog-max-len 256               # 增加慢日志长度，提供更多调试信息

################################ 延迟监控 ##############################
latency-monitor-threshold 100     # 启用延迟监控，阈值100ms

############################### 高级配置 ###############################
# 数据结构优化（Laravel 场景优化）
# Laravel 使用场景：Cache(Hash), Queue(List), Session(String/Hash)
hash-max-ziplist-entries 512      # Laravel Cache 优化，支持更多缓存条目
hash-max-ziplist-value 256        # 增加值大小，适合 Laravel 序列化数据
list-max-ziplist-size -2          # 队列优化：-2 表示 8KB，平衡性能与内存
set-max-intset-entries 512        # Laravel 集合操作优化
zset-max-ziplist-entries 128      # Laravel 排行榜/延迟队列优化
zset-max-ziplist-value 256        # 增加有序集合值大小

# 流数据结构优化
stream-node-max-bytes 8192        # 增加流节点大小，提高流处理性能
stream-node-max-entries 200       # 增加流节点条目数

# 客户端输出缓冲区限制
client-output-buffer-limit replica 128mb 64mb 120  # 从节点缓冲区限制
client-output-buffer-limit pubsub 64mb 32mb 120    # Pub/Sub缓冲区限制

# 后台任务优化
hz 20                            # 增加后台任务频率，提高响应性
dynamic-hz yes                   # 启用动态频率调整，根据负载优化

# 增量式fsync优化
aof-rewrite-incremental-fsync yes  # 启用增量式AOF重写fsync
rdb-save-incremental-fsync yes     # 启用增量式RDB保存fsync

# 连接管理优化
maxclients 5000                  # 适度减少最大连接数，避免资源耗尽
repl-backlog-size 2mb            # 增加复制积压缓冲区大小

# 线程化I/O优化（Redis 8.4增强）
io-threads 2                     # I/O线程数（1核环境建议2）
io-threads-do-reads yes          # 启用读线程，提高读取性能

# 内存碎片整理
activedefrag yes                 # 启用主动碎片整理，提高内存利用率
active-defrag-ignore-bytes 50mb  # 碎片忽略阈值
active-defrag-threshold-lower 20 # 碎片整理下限阈值
active-defrag-threshold-upper 80 # 碎片整理上限阈值

# 网络优化
repl-disable-tcp-nodelay no      # 不禁用TCP_NODELAY，减少延迟
repl-diskless-sync yes           # 启用无盘复制，提高复制性能
repl-diskless-sync-delay 2       # 减少无盘复制延迟

# 安全增强
rename-command FLUSHDB "FLUSHDB_SECURE"  # 重命名危险命令
rename-command FLUSHALL "FLUSHALL_SECURE"
rename-command CONFIG "CONFIG_SECURE"

# 监控和调试
profiling-sample-commands "get,set,incr,decr,lpush,rpush,lpop,rpop"

# 容器化优化
oom-score-adj yes                 # 调整OOM分数，提高容器稳定性

# Redis 8.4 新特性：性能监控增强
latency-tracking yes              # 启用延迟跟踪
latency-tracking-info-percentiles 50 95 99  # 延迟百分位监控

# LUA脚本优化
lua-time-limit 3000               # 减少Lua脚本超时时间，防止阻塞

# 客户端连接优化
client-query-buffer-limit 1gb     # 增加查询缓冲区限制
proto-max-bulk-len 512mb          # 增加批量操作长度限制

# 性能优化标志
jemalloc-bg-thread yes            # 启用jemalloc后台线程

################################ Laravel Queue 优化 ################################
# Laravel Queue 使用 BLPOP/BRPOP 阻塞式读取，以下配置针对队列场景优化

# 队列超时优化
timeout 0                         # 禁用客户端超时，支持长时间阻塞操作（BLPOP）

# 列表数据结构优化（Laravel Queue 使用 List）
list-max-ziplist-size -1          # 改为 -1（4KB），适合队列小消息场景
list-compress-depth 0             # 不压缩列表，提高队列处理速度

# 键空间通知（Laravel Queue 可选，用于监控）
notify-keyspace-events Ex         # 启用过期事件通知，监控延迟任务

# 连接池优化（Laravel 默认使用持久连接）
tcp-backlog 511                   # 增加TCP积压队列，处理高并发连接

# 队列场景的内存策略调整
# Laravel Queue 建议使用 noeviction，避免任务丢失
# maxmemory-policy noeviction     # 取消注释以启用（内存满时拒绝写入）

# 持久化策略建议
# 队列场景推荐：AOF everysec + RDB 备份
# 已启用 appendonly yes 和 appendfsync everysec，适合队列场景

# 复制超时优化（如果使用主从）  # 增加复制超时，避免队列处理时超时
repl-timeout 120

# 慢查询优化（监控队列性能）
# slowlog-log-slower-than 5000    # 已配置，监控慢队列操作

################################ Laravel Horizon 优化 ################################
# 如果使用 Laravel Horizon，以下配置提升监控性能

# Pub/Sub 优化（Horizon 使用 Pub/Sub 通信）
pubsub-client-output-buffer-limit 64mb 32mb 120

# 键过期优化（Horizon 使用 TTL 管理任务）  # 增加过期键清理力度（1-10，默认1）
active-expire-effort 3

# 统计信息优化 # 增加跟踪表大小，支持大量队列任务
tracking-table-max-keys 1000000

################################ 性能监控建议 ################################
# 使用以下命令监控 Laravel Queue 性能：
# redis-cli INFO stats              # 查看操作统计
# redis-cli SLOWLOG GET 10          # 查看慢查询
# redis-cli CLIENT LIST             # 查看客户端连接
# redis-cli MEMORY STATS            # 查看内存使用
# redis-cli LATENCY DOCTOR          # 延迟诊断

################################ Laravel Queue 最佳实践 ################################
# 1. 使用 Redis Sentinel 或 Cluster 提高可用性
# 2. 监控队列长度：LLEN queue_name
# 3. 设置合理的 retry_after 和 timeout
# 4. 使用 Horizon 监控队列状态
# 5. 定期清理失败任务：failed_jobs 表
# 6. 考虑使用 Redis 6.2+ 的 LMOVE 命令（Laravel 11+ 支持）
