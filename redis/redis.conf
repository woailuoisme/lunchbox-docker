# Redis 配置文件 - 1核1G内存优化版

################################## 网络配置 #####################################
bind 0.0.0.0                      # 监听所有网络接口
protected-mode no                 # 关闭保护模式（适合容器化部署）
port 6379                         # 监听端口
tcp-backlog 511                   # TCP连接队列长度
timeout 0                         # 连接不超时
tcp-keepalive 300                 # TCP保活间隔

################################# 通用配置 #####################################
daemonize no                      # 非守护进程模式
supervised no                     # 无监督模式
pidfile /var/run/redis_6379.pid   # PID文件位置
loglevel notice                   # 日志级别：notice
logfile ""                        # 日志输出到标准输出
databases 1                       # 减少数据库数量（节省内存）
always-show-logo no               # 不显示启动logo

################################## 安全配置 ##################################
requirepass your_strong_password  # 设置强密码（请修改）

################################ 快照持久化 ################################
save 900 1                        # 15分钟至少1次变更
save 300 10                       # 5分钟至少10次变更
save 60 10000                     # 1分钟至少10000次变更
stop-writes-on-bgsave-error no    # RDB失败不停止写入
rdbcompression yes                # RDB文件压缩
rdbchecksum yes                   # RDB文件校验
dbfilename dump.rdb               # RDB文件名
dir ./                            # 工作目录

############################## 内存管理 ################################
maxmemory 512mb                   # 最大内存768MB（为系统预留256MB）
maxmemory-policy volatile-lru     # 淘汰策略：淘汰过期key中的LRU
maxmemory-samples 3               # 减少采样数（降低CPU消耗）

############################# 惰性删除 ####################################
lazyfree-lazy-eviction no         # 关闭惰性删除（节省CPU）
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no
############################## AOF持久化 ###############################
appendonly no                     # 关闭AOF（节省IO资源）
################################ LUA脚本 ###############################
lua-time-limit 5000               # Lua脚本超时5秒
################################## 慢日志 ###################################
slowlog-log-slower-than 10000     # 慢查询阈值10ms
slowlog-max-len 64                # 减少慢日志长度
################################ 延迟监控 ##############################
latency-monitor-threshold 0       # 关闭延迟监控
############################### 高级配置 ###############################
# 数据结构优化（降低内存占用）
hash-max-ziplist-entries 128
hash-max-ziplist-value 64
list-max-ziplist-size -2
set-max-intset-entries 128
zset-max-ziplist-entries 64
zset-max-ziplist-value 64
hll-sparse-max-bytes 1000

# 客户端输出缓冲区限制
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 32mb 8mb 60
client-output-buffer-limit pubsub 16mb 4mb 60

# 后台任务优化
hz 10                            # 默认后台任务频率
dynamic-hz yes                   # 启用动态频率调整

# 增量式fsync优化
aof-rewrite-incremental-fsync yes
rdb-save-incremental-fsync yes
