# =============================================================================
# PostgreSQL 17.6 服务器优化配置 (2核2G内存)
# 适用于中小型应用，平衡性能与资源消耗
# =============================================================================

# -----------------------------------------------------------------------------
# 基础连接设置
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 50                    # 2G内存适中的连接数
superuser_reserved_connections = 3
authentication_timeout = 60s

# -----------------------------------------------------------------------------
# 内存设置 (核心优化区 - 2G内存配置)
# -----------------------------------------------------------------------------
shared_buffers = 512MB                  # 内存的25%，主要缓存区
effective_cache_size = 1536MB           # 内存的75%，提示优化器可用缓存
work_mem = 8MB                          # 单个操作内存，50个连接 * 8MB = 400MB
maintenance_work_mem = 128MB            # 维护操作内存（VACUUM、CREATE INDEX）
temp_buffers = 8MB                      # 临时缓冲区
dynamic_shared_memory_type = posix

# -----------------------------------------------------------------------------
# WAL 设置
# -----------------------------------------------------------------------------
wal_level = replica                     # 支持复制和备份
wal_buffers = 16MB                      # WAL缓冲区
checkpoint_completion_target = 0.9      # 平滑检查点
max_wal_size = 1GB                      # 减少检查点频率
min_wal_size = 512MB
checkpoint_timeout = 15min

# -----------------------------------------------------------------------------
# 查询优化 (SSD优化)
# -----------------------------------------------------------------------------
random_page_cost = 1.1                  # SSD随机IO成本低
seq_page_cost = 1.0
effective_io_concurrency = 100          # SSD并发IO能力

# -----------------------------------------------------------------------------
# 并行查询 (2核优化)
# -----------------------------------------------------------------------------
max_parallel_workers = 2                # 总并行工作进程数（与CPU核心数匹配）
max_parallel_workers_per_gather = 2     # 单查询最多使用2个workers
max_parallel_maintenance_workers = 1    # 维护操作并行数
parallel_leader_participation = on

# -----------------------------------------------------------------------------
# 日志设置 (Docker优化)
# -----------------------------------------------------------------------------
log_destination = 'stderr'
logging_collector = off                 # Docker环境下关闭
log_min_messages = warning
log_min_duration_statement = 1000       # 记录超过1秒的慢查询
log_connections = off
log_disconnections = off
log_line_prefix = '%t [%p]: '
log_checkpoints = on
log_autovacuum_min_duration = 500ms     # 记录执行时间超过500ms的autovacuum

# -----------------------------------------------------------------------------
# 自动清理
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 2              # 2个清理进程
autovacuum_naptime = 1min
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_delay = 5ms      # 适度延迟，避免过度占用资源
autovacuum_vacuum_cost_limit = 1000
autovacuum_work_mem = 32MB              # 清理操作可用内存

# -----------------------------------------------------------------------------
# 统计信息
# -----------------------------------------------------------------------------
track_activities = on
track_counts = on
track_io_timing = on                    # 开启IO计时
default_statistics_target = 100         # 统计信息详细度

# 可选：启用 pg_stat_statements 扩展进行查询监控
# shared_preload_libraries = 'pg_stat_statements'

# -----------------------------------------------------------------------------
# 客户端连接默认设置
# -----------------------------------------------------------------------------
default_transaction_isolation = 'read committed'
statement_timeout = 60000               # 60秒超时
lock_timeout = 30000                    # 30秒锁超时
idle_in_transaction_session_timeout = 120000  # 2分钟空闲超时
client_encoding = utf8
timezone = 'Asia/Shanghai'
datestyle = 'iso, mdy'

# -----------------------------------------------------------------------------
# 锁管理
# -----------------------------------------------------------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 64

# -----------------------------------------------------------------------------
# 后台写入优化
# -----------------------------------------------------------------------------
bgwriter_delay = 20ms                   # 适度延迟
bgwriter_lru_maxpages = 500             # 每轮写入页数
bgwriter_lru_multiplier = 2.0

# =============================================================================
# 2核2G 服务器优化配置结束
# 
# 性能调优建议：
# 1. 如果主要是读操作，可以增加 effective_cache_size
# 2. 如果写操作频繁，可以增加 wal_buffers 和 checkpoint_timeout
# 3. 监控慢查询日志，优化SQL和索引
# 4. 定期 VACUUM ANALYZE 保持统计信息准确
# =============================================================================
