# =============================================================================
# PostgresSQL 17 服务器优化配置 (1核1G内存)
# 专为 Docker 容器环境优化
# =============================================================================

# -----------------------------------------------------------------------------
# 基础连接设置 (低配优化)
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 50                    # 适度连接数，适合1核配置
superuser_reserved_connections = 2      # 减少保留连接

# -----------------------------------------------------------------------------
# 内存设置 (1G内存优化)
# -----------------------------------------------------------------------------
shared_buffers = 128MB                  # 适度增加到内存的12%
effective_cache_size = 512MB            # 适度增加到内存的50%
work_mem = 4MB                          # 适度增加单查询内存
maintenance_work_mem = 32MB             # 适度增加维护内存
temp_buffers = 4MB                      # 降低临时缓冲区

# -----------------------------------------------------------------------------
# WAL 设置 (1核1G优化)
# -----------------------------------------------------------------------------
wal_level = replica                     # 保持replica级别支持WAL流传输
max_wal_senders = 1                     # 低配服务器减少到1个发送者
wal_buffers = 2MB                       # 降低WAL缓冲区
max_wal_size = 256MB                    # 适度增加WAL大小
min_wal_size = 64MB                     # 适度增加最小WAL大小
checkpoint_timeout = 15min              # 增加检查点间隔

# -----------------------------------------------------------------------------
# 查询优化 (单核优化)
# -----------------------------------------------------------------------------
random_page_cost = 4.0                  # 假设使用机械硬盘
effective_io_concurrency = 2            # 适度增加IO并发

# -----------------------------------------------------------------------------
# 并行查询 (限制并行处理)
# -----------------------------------------------------------------------------
max_parallel_workers = 2
max_parallel_workers_per_gather = 1
max_parallel_maintenance_workers = 1

# -----------------------------------------------------------------------------
# 日志设置 (Docker 优化)
# -----------------------------------------------------------------------------
log_destination = 'stderr'
logging_collector = off                 # 关闭日志收集器节省内存
log_min_messages = error                # 只记录错误日志
log_min_duration_statement = 5000       # 记录超过5秒的查询
log_connections = off
log_disconnections = off
log_line_prefix = '%t [%p]: '
log_checkpoints = off                   # 关闭检查点日志
log_timezone = 'Asia/Shanghai'          # 设置日志时区为上海时间

# -----------------------------------------------------------------------------
# 自动清理 (1核1G优化)
# -----------------------------------------------------------------------------
autovacuum_max_workers = 1              # 只使用1个清理进程
autovacuum_naptime = 5min               # 增加清理间隔
autovacuum_vacuum_scale_factor = 0.2    # 适度降低阈值增加频率
autovacuum_analyze_scale_factor = 0.1   # 适度降低分析阈值
autovacuum_work_mem = 16MB              # 适度增加清理内存使用

# -----------------------------------------------------------------------------
# 统计信息 (最小化)
# -----------------------------------------------------------------------------
track_io_timing = off                   # 关闭IO时间统计节省资源
default_statistics_target = 100         # 适度增加统计目标

# -----------------------------------------------------------------------------
# 客户端连接默认设置
# -----------------------------------------------------------------------------
statement_timeout = 60000               # 60秒超时防止长查询
lock_timeout = 30000                    # 30秒锁超时
idle_in_transaction_session_timeout = 120000  # 2分钟空闲超时
client_encoding = utf8
timezone = 'Asia/Shanghai'
extra_float_digits = 0                  # 保持默认浮点数精度

# -----------------------------------------------------------------------------
# 锁管理 (1核1G优化)
# -----------------------------------------------------------------------------
max_locks_per_transaction = 32          # 降低锁数量

# -----------------------------------------------------------------------------
# JIT编译 (禁用以节省资源)
# -----------------------------------------------------------------------------
jit = off                               # 禁用JIT编译节省CPU资源

# -----------------------------------------------------------------------------
# 后台写入优化
# -----------------------------------------------------------------------------
bgwriter_delay = 100ms                  # 适度减少后台写入延迟
bgwriter_lru_maxpages = 100             # 适度增加每轮写入页数
bgwriter_lru_multiplier = 2.0           # 适度增加写入倍数

# -----------------------------------------------------------------------------
# 网络和连接优化
# -----------------------------------------------------------------------------
tcp_keepalives_idle = 120               # TCP保活空闲时间（2分钟）
tcp_keepalives_interval = 30            # TCP保活间隔（30秒）
tcp_keepalives_count = 3                # TCP保活次数

# -----------------------------------------------------------------------------
# 查询计划优化
# -----------------------------------------------------------------------------
enable_partitionwise_join = off         # 禁用分区智能连接节省资源
enable_partitionwise_aggregate = off    # 禁用分区智能聚合节省资源
enable_parallel_append = off            # 禁用并行追加节省资源
enable_parallel_hash = off              # 禁用并行哈希节省资源
enable_partition_pruning = on           # 启用分区修剪

# -----------------------------------------------------------------------------
# 维护和监控
# -----------------------------------------------------------------------------
log_autovacuum_min_duration = 2000      # 记录超过2秒的自动清理
log_hostname = off                      # 不记录主机名节省日志空间
log_statement = 'none'                  # 不记录SQL语句
log_recovery_conflict_waits = off       # 不记录恢复冲突等待

# =============================================================================
# 1核1G 服务器优化配置结束
# =============================================================================
