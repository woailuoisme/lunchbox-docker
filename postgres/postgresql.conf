# =============================================================================
# PostgreSQL 17.6 低配置服务器优化 (1核1G内存)
# 专为 Docker 容器环境优化
# =============================================================================

# -----------------------------------------------------------------------------
# 基础连接设置 (低配优化)
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 20                    # 大幅降低连接数
superuser_reserved_connections = 2      # 减少保留连接
authentication_timeout = 60s

# -----------------------------------------------------------------------------
# 内存设置 (1G内存优化)
# -----------------------------------------------------------------------------
shared_buffers = 64MB                   # 降低到内存的6%
effective_cache_size = 256MB            # 降低到内存的25%
work_mem = 1MB                          # 大幅降低单查询内存
maintenance_work_mem = 16MB             # 降低维护内存
temp_buffers = 4MB                      # 降低临时缓冲区
dynamic_shared_memory_type = posix      # 优化共享内存类型

# -----------------------------------------------------------------------------
# WAL 设置 (低配优化)
# -----------------------------------------------------------------------------
wal_level = replica                     # 升级为replica级别支持WAL流传输
max_wal_senders = 1                     # 低配服务器减少到1个发送者
wal_buffers = 2MB                       # 降低 WAL 缓冲区
checkpoint_completion_target = 0.9      # 延长检查点时间
max_wal_size = 128MB                    # 大幅降低 WAL 大小
min_wal_size = 32MB                     # 降低最小 WAL 大小
checkpoint_timeout = 15min              # 增加检查点间隔

# -----------------------------------------------------------------------------
# 查询优化 (单核优化)
# -----------------------------------------------------------------------------
random_page_cost = 4.0                  # 假设使用机械硬盘
seq_page_cost = 1.0
effective_io_concurrency = 1            # 单核设置为1

# -----------------------------------------------------------------------------
# 并行查询 (禁用以节省资源)
# -----------------------------------------------------------------------------
max_parallel_workers = 4
max_parallel_workers_per_gather = 2
max_parallel_maintenance_workers = 1

# -----------------------------------------------------------------------------
# 日志设置 (Docker 优化)
# -----------------------------------------------------------------------------
log_destination = 'stderr'
logging_collector = off                 # 关闭日志收集器节省内存
log_min_messages = error                # 只记录错误日志
log_min_duration_statement = 10000      # 只记录超过10秒的查询
log_connections = off
log_disconnections = off
log_line_prefix = '%t [%p]: '
log_checkpoints = off                   # 关闭检查点日志

# -----------------------------------------------------------------------------
# 自动清理 (低配优化)
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 1              # 只使用1个清理进程
autovacuum_naptime = 5min               # 增加清理间隔
autovacuum_vacuum_scale_factor = 0.4    # 增加阈值减少频率
autovacuum_analyze_scale_factor = 0.2   # 增加分析阈值
autovacuum_work_mem = 8MB               # 限制清理内存使用

# -----------------------------------------------------------------------------
# 统计信息 (最小化)
# -----------------------------------------------------------------------------
track_activities = on
track_counts = on
track_io_timing = off                   # 关闭IO时间统计节省资源
default_statistics_target = 50          # 降低统计目标

# -----------------------------------------------------------------------------
# 客户端连接默认设置
# -----------------------------------------------------------------------------
default_transaction_isolation = 'read committed'
statement_timeout = 30000               # 30秒超时防止长查询
lock_timeout = 10000                    # 10秒锁超时
idle_in_transaction_session_timeout = 60000  # 1分钟空闲超时
client_encoding = utf8
timezone = 'Asia/Shanghai'
datestyle = 'iso, mdy'

# -----------------------------------------------------------------------------
# 锁管理 (低配优化)
# -----------------------------------------------------------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 32          # 降低锁数量

# -----------------------------------------------------------------------------
# 扩展模块 (最小化)
# -----------------------------------------------------------------------------
# shared_preload_libraries = ''         # 暂时不加载扩展节省内存

# -----------------------------------------------------------------------------
# 后台写入优化
# -----------------------------------------------------------------------------
bgwriter_delay = 200ms                  # 增加后台写入延迟
bgwriter_lru_maxpages = 50              # 降低每轮写入页数
bgwriter_lru_multiplier = 1.0           # 降低写入倍数

# =============================================================================
# 1核1G 低配置优化结束
# =============================================================================
