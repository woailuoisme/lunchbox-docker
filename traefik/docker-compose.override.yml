# Traefik Docker Compose 配置
# 文件: traefik/docker-compose.override.yml
# 用法: 在主 docker-compose.yml 中取消注释 traefik 服务，或单独运行

version: '3.8'

services:
  traefik:
    container_name: traefik
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    environment:
      - TZ=${TIMEZONE:-Asia/Shanghai}
      - DOMAIN=${SITE_ADDRESS:-localhost}
      - ACME_EMAIL=${CERTBOT_EMAIL:-admin@localhost}
      # 本地开发使用 staging，生产使用正式环境
      - ACME_CA_SERVER=${ACME_CA_SERVER:-https://acme-staging-v02.api.letsencrypt.org/directory}
      # DNS 提供商凭据（如果使用 DNS 挑战）
      - CF_API_EMAIL=${CLOUDFLARE_EMAIL}
      - CF_DNS_API_TOKEN=${CLOUDFLARE_API_TOKEN}
      - CF_API_KEY=${CLOUDFLARE_API_KEY}
      - ALICLOUD_ACCESS_KEY=${ALIYUN_ACCESS_KEY_ID}
      - ALICLOUD_SECRET_KEY=${ALIYUN_ACCESS_KEY_SECRET}
    ports:
      - "80:80"       # HTTP
      - "443:443"     # HTTPS
      - "443:443/udp" # HTTP/3
      - "8080:8080"   # Dashboard (通过路由访问，不直接暴露)
      - "8082:8082"   # Metrics
      - "45432:5432"  # PostgreSQL
      - "46379:6379"  # Redis
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${CONFIG_PATH:-./}traefik/config:/config
      - ${CONFIG_PATH:-./}traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ${LOG_PATH:-./logs/}traefik:/traefik/logs
      # 如果使用 certbot 生成的证书
      - ${CONFIG_PATH:-./}certbot/conf/live:/config/certs/letsencrypt:ro
    networks:
      - frontend
      - backend
    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:80/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
    security_opt:
      - no-new-privileges:true

networks:
  frontend:
    external: true
  backend:
    external: true
