# 中间件配置
# 文件: traefik/config/dynamic/middlewares.yml

http:
  middlewares:
    # ============================================
    # 安全相关中间件
    # ============================================
    
    # 安全头中间件
    security-headers:
      headers:
        frameDeny: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        customFrameOptionsValue: "SAMEORIGIN"
        customResponseHeaders:
          X-Robots-Tag: "none,noarchive,nosnippet,notranslate,noimageindex"
          Server: ""
          X-Powered-By: ""

    # HTTPS 重定向中间件
    https-redirect:
      redirectScheme:
        scheme: https
        permanent: true
        port: "443"

    # HSTS 头中间件
    hsts:
      headers:
        forceSTSHeader: true
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true

    # ============================================
    # 认证相关中间件
    # ============================================
    
    # 基础认证中间件
    auth-basic:
      basicAuth:
        users:
          - "admin:$apr1$ShWo1lcN$D/MCo4mqE7s7PUbYcQ7aN/"
          - "develop:$apr1$DLyS08cZ$43xtmCdA1M/C6XfJYkYkA."
          - "test:$apr1$jEVx4VE2$G4aW6Db416K5gjiUMLDex."
          - "guest:$apr1$k2ij9/p6$6HTiZ6EuY4.K5k5UeKVgi1"
        removeHeader: true

    # Authelia 认证中间件
    authelia:
      forwardAuth:
        address: "http://authelia:9091/api/authz/forward-auth"
        trustForwardHeader: true
        authResponseHeaders:
          - "Remote-User"
          - "Remote-Groups"
          - "Remote-Email"
          - "Remote-Name"

    # Authelia 基础认证
    authelia-basic:
      forwardAuth:
        address: "http://authelia:9091/api/verify?auth=basic"
        trustForwardHeader: true
        authResponseHeaders:
          - "Remote-User"
          - "Remote-Groups"
          - "Remote-Email"
          - "Remote-Name"

    # ============================================
    # 错误处理中间件
    # ============================================
    
    # 错误页面中间件
    error-pages:
      errors:
        status:
          - "400-599"
        service: "error-pages@file"
        query: "/{status}.html"

    # ============================================
    # 性能优化中间件
    # ============================================
    
    # Gzip 压缩中间件
    gzip:
      compress:
        excludedContentTypes:
          - "text/event-stream"

    # 请求缓冲中间件
    buffering:
      buffering:
        maxRequestBodyBytes: 10485760  # 10MB
        maxResponseBodyBytes: 10485760  # 10MB
        memRequestBodyBytes: 2097152    # 2MB
        memResponseBodyBytes: 2097152   # 2MB
        retryExpression: "IsNetworkError() && Attempts() <= 2"

    # 重试中间件
    retry:
      retry:
        attempts: 3
        initialInterval: "100ms"

    # ============================================
    # 速率限制中间件
    # ============================================
    
    # 通用速率限制
    rate-limit:
      rateLimit:
        average: 100
        period: "1m"
        burst: 200

    # API 速率限制
    rate-limit-api:
      rateLimit:
        average: 50
        period: "1m"
        burst: 100

    # 严格速率限制
    rate-limit-strict:
      rateLimit:
        average: 10
        period: "1m"
        burst: 20

    # ============================================
    # IP 白名单中间件
    # ============================================
    
    # 内网 IP 白名单
    ip-whitelist-local:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"

    # 管理面板 IP 白名单
    ip-whitelist-admin:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "192.168.0.0/16"

    # ============================================
    # CORS 中间件
    # ============================================
    
    # 通用 CORS
    cors:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - "Authorization"
          - "Content-Type"
          - "X-Requested-With"
          - "Accept"
          - "Origin"
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "DELETE"
          - "OPTIONS"
          - "PATCH"
        accessControlAllowOriginList:
          - "https://{{ env `DOMAIN` }}"
          - "https://*.{{ env `DOMAIN` }}"
        accessControlMaxAge: 600
        addVaryHeader: true

    # API CORS（更宽松）
    cors-api:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - "*"
        accessControlAllowMethods:
          - "*"
        accessControlAllowOriginList:
          - "*"
        accessControlMaxAge: 3600

    # ============================================
    # 路径处理中间件
    # ============================================
    
    # 移除路径前缀
    strip-prefix-api:
      stripPrefix:
        prefixes:
          - "/api"
        forceSlash: false

    # 添加路径前缀
    add-prefix-v1:
      addPrefix:
        prefix: "/v1"

    # URL 重写
    rewrite-url:
      replacePathRegex:
        regex: "^/old/(.*)"
        replacement: "/new/$1"

    # ============================================
    # 链式中间件（组合使用）
    # ============================================
    
    # 标准 Web 应用链
    web-chain:
      chain:
        middlewares:
          - security-headers
          - gzip
          - error-pages

    # 受保护的 Web 应用链
    web-protected:
      chain:
        middlewares:
          - security-headers
          - authelia
          - gzip
          - error-pages

    # API 应用链
    api-chain:
      chain:
        middlewares:
          - security-headers
          - cors-api
          - rate-limit-api
          - gzip

    # 管理面板链
    admin-chain:
      chain:
        middlewares:
          - security-headers
          - ip-whitelist-admin
          - auth-basic
          - error-pages
