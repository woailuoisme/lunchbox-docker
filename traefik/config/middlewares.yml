# Traefik 中间件配置文件
# HTTP 中间件配置
http:
  middlewares:
    # Gzip 压缩中间件
    gzip:
      compress: {}

    # 基础认证中间件
    auth-basic:
      basicAuth:
        users:
          - "admin:$apr1$ShWo1lcN$D/MCo4mqE7s7PUbYcQ7aN/"
          - "develop:$apr1$DLyS08cZ$43xtmCdA1M/C6XfJYkYkA."
          - "test:$apr1$jEVx4VE2$G4aW6Db416K5gjiUMLDex."
          - "guest:$apr1$k2ij9/p6$6HTiZ6EuY4.K5k5UeKVgi1"

    authelia:
      forwardAuth:
        address: "http://authelia:9091/api/authz/forward-auth"
        ## The following commented line is for configuring the Authelia URL in the proxy. We strongly suggest this is
        ## configured in the Session Cookies section of the Authelia configuration.
        # address: 'http://authelia:9091/api/authz/forward-auth?authelia_url=https%3A%2F%2Fauth.example.com%2F'
        trustForwardHeader: true
        authResponseHeaders:
          - "Remote-User"
          - "Remote-Groups"
          - "Remote-Email"
          - "Remote-Name"
    authelia-basic:
      forwardAuth:
        address: "http://authelia:9091/api/verify?auth=basic"
        trustForwardHeader: true
        authResponseHeaders:
          - "Remote-User"
          - "Remote-Groups"
          - "Remote-Email"
          - "Remote-Name"
    # 错误页面中间件
    error-pages:
      errors:
        status:
          - "400-599"
        service: "error-pages"
        query: "/{status}.html"

    # 安全头中间件
    security-headers:
      headers:
        frameDeny: true
        sslRedirect: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000

    # 速率限制中间件
    rate-limit:
      rateLimit:
        burst: 100
        period: "1m"
        average: 30

    # IP 白名单中间件
    ip-whitelist:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"

    # 重定向中间件
    https-redirect:
      redirectScheme:
        scheme: https
        permanent: true

    # 路径前缀中间件
    strip-prefix:
      stripPrefix:
        prefixes:
          - "/api"

    # 添加前缀中间件
    add-prefix:
      addPrefix:
        prefix: "/v1"

    # 重试中间件
    retry:
      retry:
        attempts: 3
        initialInterval: "100ms"

    # 请求缓冲中间件
    buffering:
      buffering:
        maxRequestBodyBytes: 10485760
        maxResponseBodyBytes: 10485760
        memRequestBodyBytes: 2097152
        memResponseBodyBytes: 2097152
        retryExpression: "IsNetworkError() && Attempts() <= 2"

    # 跨域中间件
    cors:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - "Authorization"
          - "Content-Type"
          - "X-Requested-With"
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "DELETE"
          - "OPTIONS"
        accessControlAllowOriginList:
          - "https://yourdomain.com"
        accessControlMaxAge: 600

    # 重写 URL 中间件
    rewrite-url:
      replacePathRegex:
        regex: "^/old/(.*)"
        replacement: "/new/$1"
