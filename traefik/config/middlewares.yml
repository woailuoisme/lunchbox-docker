# Traefik 中间件配置文件
# 适配 Traefik 3.5.4 - 本地和线上兼容版本

# HTTP 中间件配置
http:
  middlewares:
    # Gzip 压缩中间件
    gzip:
      compress: {}

    # 基础认证中间件
    auth-basic:
      basicAuth:
        users:
          - "admin:$2y$10$example_hashed_password_here"

    # Authelia 认证中间件
    authelia:
      forwardAuth:
        address: "http://authelia:9091/api/verify"
        trustForwardHeader: true
        authResponseHeaders:
          - "Remote-User"
          - "Remote-Groups"
          - "Remote-Name"
          - "Remote-Email"

    # 错误页面中间件
    error-pages:
      errors:
        status:
          - "400-599"
        service: "error-pages"
        query: "/{status}.html"

    # 安全头中间件
    security-headers:
      headers:
        frameDeny: true
        sslRedirect: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000

    # 路径过滤中间件 - 屏蔽敏感文件和目录
    path-filter:
      chain:
        middlewares:
          - "block-hidden-files"
          - "block-backup-files"
          - "block-config-files"
          - "block-db-files"
          - "block-dev-files"
          - "block-admin-paths"

    # 屏蔽隐藏文件
    block-hidden-files:
      regexRedirect:
        regex: "^/\\.(.*)"
        replacement: "/404"
        permanent: false

    # 屏蔽备份文件
    block-backup-files:
      regexRedirect:
        regex: ".*\\.(bak|backup|old|orig|save|swp|swo|tmp|temp|cache|~)$"
        replacement: "/404"
        permanent: false

    # 屏蔽配置文件
    block-config-files:
      regexRedirect:
        regex: ".*\\.(ini|conf|cnf|yml|yaml|toml|env|config)$"
        replacement: "/404"
        permanent: false

    # 屏蔽数据库文件
    block-db-files:
      regexRedirect:
        regex: ".*\\.(sql|sqlite|db|mdb)$"
        replacement: "/404"
        permanent: false

    # 屏蔽开发文件
    block-dev-files:
      regexRedirect:
        regex: "^/(vendor|node_modules|bower_components|\\.npm|\\.composer|\\.cargo)/"
        replacement: "/404"
        permanent: false

    # 屏蔽后台管理路径
    block-admin-paths:
      regexRedirect:
        regex: "^/(phpmyadmin|pma|adminer|phpminiadmin|mysql|myadmin|wp-admin|wp-login\\.php|wp-config\\.php|xmlrpc\\.php)/"
        replacement: "/404"
        permanent: false

    # 屏蔽源代码文件
    block-source-files:
      regexRedirect:
        regex: ".*\\.(py|rb|pl|sh|bash|java|class|jar)$"
        replacement: "/404"
        permanent: false

    # 屏蔽常见漏洞探测路径
    block-probe-paths:
      regexRedirect:
        regex: "^/(console|api/v1/pods|actuator|jolokia|hawtio|test|tests|spec|specs|debug|phpinfo\\.php|info\\.php)/"
        replacement: "/404"
        permanent: false

    # 应用认证中间件 - 智能路径认证
    # 对 /docs, /logs, /pulse 路径启用 Authelia 认证
    # 其他路径无需认证
    app-auth:
      forwardAuth:
        address: "http://authelia:9091/api/verify"
        trustForwardHeader: true
        authResponseHeaders:
          - "Remote-User"
          - "Remote-Groups"
          - "Remote-Name"
          - "Remote-Email"

    # 请求头安全检查中间件
    header-security:
      headers:
        customRequestHeaders:
          X-Security-Check: "enabled"
        customResponseHeaders:
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "DENY"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"

    # 恶意 User-Agent 检测中间件
    bad-user-agent:
      headers:
        customRequestHeaders:
          X-User-Agent-Check: "enabled"

    # SQL 注入检测中间件
    sql-injection-check:
      headers:
        customRequestHeaders:
          X-SQL-Injection-Check: "enabled"

    # 路径遍历检测中间件
    path-traversal-check:
      headers:
        customRequestHeaders:
          X-Path-Traversal-Check: "enabled"

    # 速率限制中间件
    rate-limit:
      rateLimit:
        burst: 100
        period: "1m"
        average: 30

    # IP 白名单中间件
    ip-whitelist:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "10.0.0.0/8"
          - "172.16.0.0/12"
          - "192.168.0.0/16"

    # 重定向中间件
    https-redirect:
      redirectScheme:
        scheme: https
        permanent: true

    # 路径前缀中间件
    strip-prefix:
      stripPrefix:
        prefixes:
          - "/api"

    # 添加前缀中间件
    add-prefix:
      addPrefix:
        prefix: "/v1"

    # 重试中间件
    retry:
      retry:
        attempts: 3
        initialInterval: "100ms"

    # 请求缓冲中间件
    buffering:
      buffering:
        maxRequestBodyBytes: 10485760
        maxResponseBodyBytes: 10485760
        memRequestBodyBytes: 2097152
        memResponseBodyBytes: 2097152
        retryExpression: "IsNetworkError() && Attempts() <= 2"

    # 请求超时中间件
    timeout:
      chain:
        middlewares:
          - "retry@file"
        requestTimeout: "30s"

    # 跨域中间件
    cors:
      headers:
        accessControlAllowCredentials: true
        accessControlAllowHeaders:
          - "Authorization"
          - "Content-Type"
          - "X-Requested-With"
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "DELETE"
          - "OPTIONS"
        accessControlAllowOriginList:
          - "https://yourdomain.com"
        accessControlMaxAge: 600

    # 压缩中间件 (替代 gzip)
    compress:
      compress: {}

    # 基础认证中间件 (替代 auth-basic)
    basic-auth:
      basicAuth:
        users:
          - "admin:$2y$10$example_hashed_password_here"

    # 重写 URL 中间件
    rewrite-url:
      replacePathRegex:
        regex: "^/old/(.*)"
        replacement: "/new/$1"

    # 自定义错误页面中间件
    custom-errors:
      errors:
        status:
          - "400-599"
        service: "error-pages"
        query: "/error/{status}"

    # 完整安全中间件链
    security-full:
      chain:
        middlewares:
          - "rate-limit@file"
          - "ip-whitelist@file"
          - "security-headers@file"
          - "path-filter@file"
          - "header-security@file"

    # Web 应用安全中间件链
    web-security:
      chain:
        middlewares:
          - "security-headers@file"
          - "path-filter@file"
          - "header-security@file"

    # API 安全中间件链
    api-security:
      chain:
        middlewares:
          - "rate-limit@file"
          - "cors@file"
          - "security-headers@file"
          - "header-security@file"
