# Traefik 3.6 主配置文件
# 适用于本地开发和生产环境

# API 和 Dashboard 配置
api:
  dashboard: true
  insecure: false  # 通过路由访问，不使用不安全端口

# 全局配置
global:
  checkNewVersion: false
  sendAnonymousUsage: false

# 日志配置
log:
  level: INFO
  format: json
  filePath: /traefik/logs/traefik.log

# 访问日志
accessLog:
  filePath: /traefik/logs/access.log
  format: json
  bufferingSize: 100
  filters:
    statusCodes:
      - "400-599"
    retryAttempts: true
    minDuration: "10ms"

# 指标监控配置
metrics:
  prometheus:
    entryPoint: metrics
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true

# 入口点配置
entryPoints:
  # HTTP 入口点 - 重定向到 HTTPS
  web:
    address: ":80"
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
          permanent: true

  # HTTPS 入口点
  websecure:
    address: ":443"
    http:
      tls:
        options: default
        certResolver: default
      middlewares:
        - security-headers@file
    http2:
      maxConcurrentStreams: 250
    http3:
      advertisedPort: 443

  # 监控指标入口点
  metrics:
    address: ":8082"

  # 数据库服务入口点
  postgres:
    address: ":5432"
  
  redis:
    address: ":6379"

# 服务发现提供者配置
providers:
  # 文件提供者 - 动态配置
  file:
    directory: /config/dynamic
    watch: true

# Ping 健康检查端点
ping:
  entryPoint: web
  manualRouting: true

# 证书解析器配置
certificatesResolvers:
  # 默认解析器 - 本地自签名证书
  default:
    acme:
      email: "{{ env `ACME_EMAIL` }}"
      storage: /config/acme/acme.json
      caServer: "{{ env `ACME_CA_SERVER` }}"
      keyType: EC384
      # HTTP 挑战
      httpChallenge:
        entryPoint: web

  # Let's Encrypt 生产环境
  letsencrypt:
    acme:
      email: "{{ env `ACME_EMAIL` }}"
      storage: /config/acme/letsencrypt.json
      caServer: "https://acme-v02.api.letsencrypt.org/directory"
      keyType: EC384
      httpChallenge:
        entryPoint: web

  # Cloudflare DNS 挑战
  cloudflare:
    acme:
      email: "{{ env `ACME_EMAIL` }}"
      storage: /config/acme/cloudflare.json
      caServer: "https://acme-v02.api.letsencrypt.org/directory"
      keyType: EC384
      dnsChallenge:
        provider: cloudflare
        delayBeforeCheck: 30
        resolvers:
          - "1.1.1.1:53"
          - "1.0.0.1:53"

  # 阿里云 DNS 挑战
  aliyun:
    acme:
      email: "{{ env `ACME_EMAIL` }}"
      storage: /config/acme/aliyun.json
      caServer: "https://acme-v02.api.letsencrypt.org/directory"
      keyType: EC384
      dnsChallenge:
        provider: alidns
        delayBeforeCheck: 30
        resolvers:
          - "223.5.5.5:53"
          - "223.6.6.6:53"

# TLS 配置
tls:
  options:
    default:
      minVersion: VersionTLS12
      maxVersion: VersionTLS13
      cipherSuites:
        - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305
        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305
      curvePreferences:
        - CurveP521
        - CurveP384
      sniStrict: false
      alpnProtocols:
        - h2
        - http/1.1

    modern:
      minVersion: VersionTLS13
      sniStrict: true
      alpnProtocols:
        - h2
        - http/1.1

# 序列化配置
serversTransport:
  insecureSkipVerify: false
  maxIdleConnsPerHost: 200
