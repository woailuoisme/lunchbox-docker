name: ğŸš€ Sync All DockerHub Images to Tencent Cloud TCR

on:
  # æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ
  workflow_dispatch:
  # å®šæ—¶ä»»åŠ¡ï¼Œæ¯å¤©å‡Œæ™¨ 02:00 æ‰§è¡Œ
  schedule:
    - cron: "0 18 * * *" # UTC 18:00 = åŒ—äº¬æ—¶é—´ 02:00

jobs:
  sync_all_images:
    runs-on: ubuntu-latest
    env:
      # Docker Hub ä»“åº“åç§°
      DOCKER_HUB_REPO: jiaoio
      # è…¾è®¯äº‘ TCR å‘½åç©ºé—´
      TCR_NAMESPACE: jiaoio

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # --- 1. ç™»å½• Docker Hub ---
      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # --- 2. ç™»å½•è…¾è®¯äº‘ TCR ---
      - name: ğŸ” Login to Tencent Cloud Registry (TCR)
        uses: docker/login-action@v3
        with:
          registry: jiaoio
          username: ${{ secrets.TENCENT_REGISTRY_USERNAME }}
          password: ${{ secrets.TENCENT_REGISTRY_PASSWORD }}

      # --- 3. å®‰è£… Skopeo å’Œ curl (ç”¨äºé•œåƒå¤åˆ¶å’Œ API è°ƒç”¨) ---
      - name: ğŸ“¦ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo curl jq

      - name: ğŸ” Synchronize All Images with All Tags from Docker Hub to TCR
        run: |
          # æ£€æŸ¥ images.txt æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f images.txt ]; then
            echo "âŒ Error: images.txt not found!"
            exit 1
          fi

          echo "ğŸ“‹ å¼€å§‹åŒæ­¥é•œåƒåˆ—è¡¨..."

          # ç»Ÿè®¡å˜é‡
          TOTAL_IMAGES=0
          TOTAL_TAGS=0
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          FAILED_IMAGES=""

          # é€è¡Œè¯»å– images.txt æ–‡ä»¶
          while IFS= read -r IMAGE_NAME; do
            # è·³è¿‡æ³¨é‡Šå’Œç©ºè¡Œ
            if [[ "$IMAGE_NAME" =~ ^#.* ]] || [[ -z "$IMAGE_NAME" ]]; then
              continue
            fi

            TOTAL_IMAGES=$((TOTAL_IMAGES + 1))

            echo "--- ğŸ” è·å–é•œåƒæ ‡ç­¾: ${IMAGE_NAME} ---"

            # ä½¿ç”¨ Docker Hub API è·å–æ‰€æœ‰æ ‡ç­¾
            TAGS_JSON=$(curl -s "https://hub.docker.com/v2/repositories/${DOCKER_HUB_REPO}/${IMAGE_NAME}/tags/?page_size=100" || echo "{}")

            # æ£€æŸ¥ API å“åº”æ˜¯å¦æœ‰æ•ˆ
            if [ "$(echo "$TAGS_JSON" | jq -r '.results // empty')" = "null" ] || [ -z "$(echo "$TAGS_JSON" | jq -r '.results[0].name // empty')" ]; then
              echo "âš ï¸ æ— æ³•è·å– ${IMAGE_NAME} çš„æ ‡ç­¾åˆ—è¡¨ï¼Œè·³è¿‡æ­¤é•œåƒ"
              continue
            fi

            # æå–æ‰€æœ‰æ ‡ç­¾åç§°
            TAGS=$(echo "$TAGS_JSON" | jq -r '.results[].name' | grep -v '^$')

            if [ -z "$TAGS" ]; then
              echo "âš ï¸ ${IMAGE_NAME} æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ ‡ç­¾ï¼Œè·³è¿‡æ­¤é•œåƒ"
              continue
            fi

            TAG_COUNT=$(echo "$TAGS" | wc -l)
            TOTAL_TAGS=$((TOTAL_TAGS + TAG_COUNT))

            echo "ğŸ“¦ æ‰¾åˆ° ${TAG_COUNT} ä¸ªæ ‡ç­¾:"
            echo "$TAGS" | head -10
            if [ $TAG_COUNT -gt 10 ]; then
              echo "... å’Œ $((TAG_COUNT - 10)) ä¸ªå…¶ä»–æ ‡ç­¾"
            fi

            # åŒæ­¥æ¯ä¸ªæ ‡ç­¾
            while IFS= read -r TAG; do
              if [ -z "$TAG" ]; then
                continue
              fi

              SOURCE_IMAGE="docker://${DOCKER_HUB_REPO}/${IMAGE_NAME}:${TAG}"
              TARGET_IMAGE="docker://${{ secrets.TCR_REGISTRY }}/${TCR_NAMESPACE}/${IMAGE_NAME}:${TAG}"

              echo "--- ğŸ”„ æ­£åœ¨åŒæ­¥: ${IMAGE_NAME}:${TAG} ---"
              echo "æºé•œåƒ: ${SOURCE_IMAGE}"
              echo "ç›®æ ‡é•œåƒ: ${TARGET_IMAGE}"

              # ä½¿ç”¨ skopeo copy --all å‘½ä»¤åŒæ­¥é•œåƒåŠå…¶æ‰€æœ‰æ¶æ„
              if skopeo copy \
                --all \
                --retry-times 3 \
                --src-tls-verify=false \
                --dest-tls-verify=false \
                "${SOURCE_IMAGE}" \
                "${TARGET_IMAGE}"; then

                echo "âœ… åŒæ­¥æˆåŠŸ: ${IMAGE_NAME}:${TAG}"
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              else
                echo "âŒ åŒæ­¥å¤±è´¥: ${IMAGE_NAME}:${TAG}"
                FAILED_COUNT=$((FAILED_COUNT + 1))
                FAILED_IMAGES="${FAILED_IMAGES}${IMAGE_NAME}:${TAG}\n"
              fi

              echo ""

            done <<< "$TAGS"

          done < images.txt

          # è¾“å‡ºåŒæ­¥ç»“æœç»Ÿè®¡
          echo "ğŸ‰ åŒæ­¥å®Œæˆ!"
          echo "========================================"
          echo "ğŸ“Š åŒæ­¥ç»Ÿè®¡:"
          echo "æ€»é•œåƒæ•°: ${TOTAL_IMAGES}"
          echo "æ€»æ ‡ç­¾æ•°: ${TOTAL_TAGS}"
          echo "æˆåŠŸæ•°: ${SUCCESS_COUNT}"
          echo "å¤±è´¥æ•°: ${FAILED_COUNT}"

          if [ $FAILED_COUNT -gt 0 ]; then
            echo ""
            echo "âŒ å¤±è´¥çš„é•œåƒæ ‡ç­¾:"
            echo -e "${FAILED_IMAGES}"
            # å¦‚æœæœ‰å¤±è´¥çš„é•œåƒï¼Œå·¥ä½œæµæ ‡è®°ä¸ºå¤±è´¥
            exit 1
          else
            echo ""
            echo "âœ… æ‰€æœ‰é•œåƒæ ‡ç­¾åŒæ­¥æˆåŠŸ!"
          fi

#      - name: ğŸ“§ Send Notification (å¯é€‰)
#        if: always()
#        uses: 8398a7/action-slack@v3
#        with:
#          status: ${{ job.status }}
#          channel: "#deployments"
#          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
#        env:
#          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
