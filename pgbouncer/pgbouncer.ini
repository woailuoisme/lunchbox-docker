[databases]
; 数据库配置部分
; 配置通配符，将所有客户端连接路由到同一个 PostgreSQL 实例
;* = host=postgres port=5432 user=postgres dbname=*
; 指定 lunchbox 数据库的连接配置
lunchbox = host=postgres port=5432 user=postgres dbname=lunchbox
; 指定 domost 数据库的连接配置
domost = host=postgres  port=5432 user=postgres dbname=domost

[pgbouncer]
; PgBouncer 主要配置部分
; 监听端口从 5432 更改为 6432，避免和 PostgreSQL 端口冲突
listen_port = 6432
; 监听地址，0.0.0.0 表示监听所有网络接口
listen_addr = 0.0.0.0
; 认证类型，使用 scram-sha-256 加密认证
auth_type = scram-sha-256
; 认证文件路径，包含用户凭据信息
auth_file = /etc/pgbouncer/userlist.txt

; 连接池设置 (1核1G优化)
; 连接池模式，使用事务级池化
pool_mode = transaction
; 最大客户端连接数
max_client_conn = 100
; 默认连接池大小
default_pool_size = 10
; 最小连接池大小
min_pool_size = 2
; 保留连接池大小，用于紧急情况
reserve_pool_size = 2
; 保留池超时时间（秒）
reserve_pool_timeout = 5
; 每个数据库的最大连接数
max_db_connections = 15
; 每个用户的最大连接数
max_user_connections = 15

; 连接超时设置
; 服务器连接超时时间（秒）
server_connect_timeout = 15
; 服务器登录重试间隔（秒）
server_login_retry = 15
; 查询超时时间（秒），0表示无限制
query_timeout = 0
; 查询等待超时时间（秒）
query_wait_timeout = 120
; 客户端空闲超时时间（秒），0表示无限制
client_idle_timeout = 0
; 客户端登录超时时间（秒）
client_login_timeout = 60
; 自动数据库空闲超时时间（秒）
autodb_idle_timeout = 3600

; 日志设置 (Docker优化)
; 管理员用户列表
admin_users = postgres
; 统计信息用户列表
stats_users = postgres
; 是否记录连接日志
log_connections = 1
; 是否记录断开连接日志
log_disconnections = 1
; 是否记录池化错误日志
log_pooler_errors = 1
; 是否使用系统日志，0表示不使用
syslog = 0

; 内存和性能优化
; 在应用名称中添加主机信息
application_name_add_host = 1
; 配置文件路径
conffile = /etc/pgbouncer/pgbouncer.ini
; PID文件路径
;pidfile = /tmp/pgbouncer.pid
; Unix套接字目录 (使用Bitnami默认设置)
unix_socket_dir = /tmp

; 忽略启动参数 (兼容性)
; 忽略的启动参数列表，提高兼容性
ignore_startup_parameters = extra_float_digits,search_path

; 服务器检查间隔
; 服务器检查延迟时间（秒）
server_check_delay = 30
; 服务器检查查询语句
server_check_query = select 1

; 连接重试和故障处理
; 是否快速关闭服务器连接
server_fast_close = 0
; 服务器生命周期（秒）
server_lifetime = 3600
; 服务器空闲超时时间（秒）
server_idle_timeout = 600
