# =============================================================================
# PostgresSQL 17.6 低配置服务器优化 (1核1G内存)
# 专为 Docker 容器环境优化
# =============================================================================

# -----------------------------------------------------------------------------
# 基础连接设置 (低配优化)
# -----------------------------------------------------------------------------
listen_addresses = '*'
port = 5432
max_connections = 50                    # 适度连接数
superuser_reserved_connections = 2      # 减少保留连接
authentication_timeout = 60s

# -----------------------------------------------------------------------------
# 内存设置 (1G内存优化)
# -----------------------------------------------------------------------------
shared_buffers = 128MB                  # 适度增加到内存的12%
effective_cache_size = 512MB            # 适度增加到内存的50%
work_mem = 4MB                          # 适度增加单查询内存
maintenance_work_mem = 32MB             # 适度增加维护内存
temp_buffers = 4MB                      # 降低临时缓冲区
dynamic_shared_memory_type = posix      # 优化共享内存类型

# -----------------------------------------------------------------------------
# WAL 设置 (低配优化)
# -----------------------------------------------------------------------------
wal_level = replica                     # 升级为replica级别支持WAL流传输
max_wal_senders = 1                     # 低配服务器减少到1个发送者
wal_buffers = 2MB                       # 降低 WAL 缓冲区
checkpoint_completion_target = 0.9      # 延长检查点时间
max_wal_size = 256MB                    # 适度增加 WAL 大小
min_wal_size = 64MB                     # 适度增加最小 WAL 大小
checkpoint_timeout = 15min              # 增加检查点间隔

# -----------------------------------------------------------------------------
# 查询优化 (单核优化)
# -----------------------------------------------------------------------------
random_page_cost = 4.0                  # 假设使用机械硬盘
seq_page_cost = 1.0
effective_io_concurrency = 2            # 适度增加IO并发

# -----------------------------------------------------------------------------
# 并行查询 (禁用以节省资源)
# -----------------------------------------------------------------------------
max_parallel_workers = 2
max_parallel_workers_per_gather = 1
max_parallel_maintenance_workers = 1

# -----------------------------------------------------------------------------
# 日志设置 (Docker 优化)
# -----------------------------------------------------------------------------
log_destination = 'stderr'
logging_collector = off                 # 关闭日志收集器节省内存
log_min_messages = error                # 只记录错误日志
log_min_duration_statement = 5000       # 记录超过5秒的查询
log_connections = off
log_disconnections = off
log_line_prefix = '%t [%p]: '
log_checkpoints = off                   # 关闭检查点日志

# -----------------------------------------------------------------------------
# 自动清理 (低配优化)
# -----------------------------------------------------------------------------
autovacuum = on
autovacuum_max_workers = 1              # 只使用1个清理进程
autovacuum_naptime = 5min               # 增加清理间隔
autovacuum_vacuum_scale_factor = 0.2    # 适度降低阈值增加频率
autovacuum_analyze_scale_factor = 0.1   # 适度降低分析阈值
autovacuum_work_mem = 16MB              # 适度增加清理内存使用

# -----------------------------------------------------------------------------
# 统计信息 (最小化)
# -----------------------------------------------------------------------------
track_activities = on
track_counts = on
track_io_timing = off                   # 关闭IO时间统计节省资源
default_statistics_target = 100         # 适度增加统计目标

# -----------------------------------------------------------------------------
# 客户端连接默认设置
# -----------------------------------------------------------------------------
default_transaction_isolation = 'read committed'
statement_timeout = 60000               # 60秒超时防止长查询
lock_timeout = 30000                    # 30秒锁超时
idle_in_transaction_session_timeout = 120000  # 2分钟空闲超时
client_encoding = utf8
timezone = 'Asia/Shanghai'
datestyle = 'iso, mdy'

# -----------------------------------------------------------------------------
# 锁管理 (低配优化)
# -----------------------------------------------------------------------------
deadlock_timeout = 1s
max_locks_per_transaction = 32          # 降低锁数量

# -----------------------------------------------------------------------------
# 扩展模块 (PostGIS 支持)
# -----------------------------------------------------------------------------
# shared_preload_libraries = ''         # 暂时不加载扩展节省内存


# -----------------------------------------------------------------------------
# 后台写入优化
# -----------------------------------------------------------------------------
bgwriter_delay = 100ms                  # 适度减少后台写入延迟
bgwriter_lru_maxpages = 100             # 适度增加每轮写入页数
bgwriter_lru_multiplier = 2.0           # 适度增加写入倍数

# =============================================================================
# 1核1G 低配置优化结束
# =============================================================================
