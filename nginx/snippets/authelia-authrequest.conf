# 更新的Authelia认证请求配置 - 基于最新官方文档

# 发送子请求到Authelia验证用户身份和权限
auth_request /internal/authelia/authz;

# 保存Authelia响应的用户元数据到变量
auth_request_set $user $upstream_http_remote_user;
auth_request_set $groups $upstream_http_remote_groups;
auth_request_set $name $upstream_http_remote_name;
auth_request_set $email $upstream_http_remote_email;

# 将用户元数据注入到发送给后端的请求中
proxy_set_header Remote-User $user;
proxy_set_header Remote-Groups $groups;
proxy_set_header Remote-Email $email;
proxy_set_header Remote-Name $name;

# 配置认证失败时的重定向 - 现代方法
# 现代方法：将$redirection_url设置为认证端点响应的Location头部
auth_request_set $redirection_url $upstream_http_location;

# 现代方法：当认证端点返回401时重定向到$redirection_url
error_page 401 =302 $redirection_url;