(proxy-app-subpath-auth) {
	{args[0]} {
		import ../snippets/request-log.conf
		import ../snippets/security.conf
		encode zstd gzip

		# 1. 修复重定向逻辑：访问 /grafana 自动跳转到 /grafana/
		# 这样可以确保浏览器正确处理子路径下的相对资源
		redir /{args[1]} /{args[1]}/ 301

		# 2. 处理子路径请求
		handle_path /{args[1]}/* {
			import ../snippets/authelia.conf

			# 反向代理到后端服务
			reverse_proxy {args[2]} {
				# 某些后端（如 Grafana/Nextcloud）可能需要设置标头
				header_up Host {host}
				header_up X-Real-IP {remote_host}
			}
		}
	}
}
