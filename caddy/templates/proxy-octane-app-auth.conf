# ===============================================
# Caddyfile
# ===============================================

# --- 1. 命名片段 (proxy-app-auth) 定义 ---
# {args.0} = 站点地址 (e.g., octane.test.local)
# {args.1} = 后端应用地址 (e.g., php-franken:8001)

(proxy-octane-app-auth) {
	{args[0]} {
		# 启用访问日志
		import ../snippets/request-log.conf
		# 全局指令
		import ../snippets/security.conf
		encode zstd gzip

		# A. 定义需要受保护的路径匹配器
		@protected {
			path /docs*
			path /log-viewer*
			path /horizon*
		}

		# B. 处理所有受保护的请求 (应用认证)
		handle @protected {
			forward_auth authelia:9091 {
				uri /api/authz/forward-auth
				copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
			}
			# 认证通过后，代理到后端应用
			reverse_proxy {args[1]}
		}

		# C. Authelia 自身服务的代理 (不需要认证)
		handle /authelia* {
			reverse_proxy authelia:9091
		}

		# D. 处理所有其他请求 (不应用认证)
		# 这一块会处理根路径 / 和所有其他未被上面 handle 块捕获的路径。
		handle {
			reverse_proxy {args[1]}
		}
	}
}
